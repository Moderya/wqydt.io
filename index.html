<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <!-- è§†å£é€‚é…ï¼šç§»åŠ¨ç«¯æ»¡å±ã€ç¦æ­¢ç”¨æˆ·ç¼©æ”¾ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è¥¿å—æ—ä¸šå¤§å­¦æ™ºæ…§æ ¡å›­åœ°å›¾</title>
  
  <style>
    /* ===== åŸºç¡€å…¨å±€æ ·å¼é‡ç½® ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      font-family: "Microsoft YaHei", Arial, sans-serif;
      overflow: hidden; /* ç¦æ­¢é¡µé¢æ•´ä½“æ»šåŠ¨ */
    }
    
    /* åœ°å›¾æ ¸å¿ƒå®¹å™¨ï¼šå æ»¡æ•´ä¸ªé¡µé¢ */
    #container {
      width: 100%;
      height: 100%;
      position: relative;
    }
    
    /* ===== åŠ è½½åŠ¨ç”»é®ç½©å±‚æ ·å¼ ===== */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      transition: opacity 0.3s ease;
    }
    /* åŠ è½½åŠ¨ç”»-æ—‹è½¬åœ†åœˆ */
    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #009688;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ===== å·¦ä¾§ä¾§è¾¹æ æ ·å¼ ===== */
    .sidebar {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 300px;
      max-width: 90%; /* ç§»åŠ¨ç«¯æœ€å¤§å®½åº¦é™åˆ¶ */
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      z-index: 10; /* é«˜äºåœ°å›¾ï¼Œä½äºåŠ è½½å±‚ */
      padding: 20px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .sidebar h3 {
      color: #009688; /* ä¸»é¢˜è‰² */
      margin-bottom: 15px;
      font-size: 18px;
    }
    /* ä¾§è¾¹æ ç‚¹ä½é¡¹æ ·å¼ */
    .spot-item {
      padding: 10px 0;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .spot-item:hover {
      background-color: #f9f9f9;
    }
    .spot-item strong {
      color: #333;
      font-size: 14px;
    }
    .spot-item p {
      font-size: 12px;
      color: #666;
      margin: 4px 0 0 0;
      line-height: 1.4;
    }

    /* ===== å“åº”å¼è®¾è®¡ï¼šé€‚é…æ‰‹æœº/å¹³æ¿ ===== */
    @media (max-width: 768px) {
      .sidebar {
        width: calc(100% - 40px);
        max-height: 200px;
      }
    }
    @media (max-width: 480px) {
      .sidebar {
        padding: 15px;
      }
      .sidebar h3 {
        font-size: 16px;
      }
      .spot-item strong {
        font-size: 13px;
      }
      .spot-item p {
        font-size: 11px;
      }
    }
  </style>
</head>

<body>
  <!-- åŠ è½½é®ç½©ï¼šåœ°å›¾åŠ è½½ä¸­æ˜¾ç¤ºï¼ŒåŠ è½½å®Œæˆéšè— -->
  <div id="loading" class="loading-overlay">
    <div class="spinner"></div>
    <p>æ­£åœ¨åŠ è½½æ ¡å›­åœ°å›¾...</p>
  </div>
  
  <!-- å·¦ä¾§ä¾§è¾¹æ ï¼šæ ¡å›­ä»‹ç» + ç‚¹ä½åˆ—è¡¨ -->
  <div class="sidebar" id="sidebar">
    <h3>è¥¿å—æ—ä¸šå¤§å­¦æ™ºæ…§æ ¡å›­</h3>
    <p id="campus-intro"></p>
    <div id="spot-list" style="margin-top: 15px;"></div>
  </div>
  
  <!-- åœ°å›¾æ ¸å¿ƒå®¹å™¨ -->
  <div id="container"></div>

  <!-- é«˜å¾·åœ°å›¾å®‰å…¨é…ç½® -->
  <script type="text/javascript">
    window._AMapSecurityConfig = {
      securityJsCode: "50f177b3ea427e38fc9eaa98d293d074"
    };
  </script>
  
  <!-- é«˜å¾·åœ°å›¾APIåŠ è½½å™¨ -->
  <script src="https://webapi.amap.com/loader.js"></script>
  
  <!-- ä¸»åº”ç”¨è„šæœ¬ï¼ˆæ¢å¤ä»‹ç»æ–‡å­—+åˆ é™¤å®éªŒæ¥¼+é‡æ–°æ’å¸ƒæ ‡è®°ä½ç½®ï¼‰ -->
  <script type="text/javascript">
    // ========= å…¨å±€é…ç½®å¸¸é‡ï¼ˆåˆ é™¤å®éªŒæ¥¼+é‡æ–°è°ƒæ•´åæ ‡ï¼‰ =========
    const CONFIG = {
      amapKey: "3b181b254d0697c7ea2488fecc5abb2f", // é«˜å¾·åœ°å›¾Key
      campus: {
        name: "è¥¿å—æ—ä¸šå¤§å­¦ï¼ˆæ ¡æœ¬éƒ¨ï¼‰",
        center: [102.757000, 25.058000], // è°ƒæ•´æ ¡å›­ä¸­å¿ƒç‚¹ï¼Œè®©æ ‡è®°åˆ†å¸ƒæ›´å±…ä¸­
        zoom: 17, // åœ°å›¾é»˜è®¤ç¼©æ”¾çº§åˆ«
        intro: `è¥¿å—æ—ä¸šå¤§å­¦ï¼ˆæ ¡æœ¬éƒ¨ï¼‰åœ°å¤„äº‘å—çœæ˜†æ˜å¸‚ç›˜é¾™åŒºç™½é¾™å¯º300å·ã€‚`,
        spots: [ // åˆ é™¤å®éªŒæ¥¼ + é‡æ–°è°ƒæ•´æ‰€æœ‰ç‚¹ä½åæ ‡ï¼ˆé¿å…é‡å ï¼Œåˆ†å¸ƒæ›´åˆç†ï¼‰
          { 
            id: 2, 
            position: [102.755000, 25.059000], // è‡³çœŸæ¥¼ï¼šè¥¿åŒ—ä¾§
            name: "è‡³çœŸæ¥¼", 
            type: "academic", 
            desc: "ä¸»æ‰“æ–‡ç†ç±»åŸºç¡€è¯¾ç¨‹æ•™å­¦çš„æ ¸å¿ƒæ•™å­¦æ¥¼", 
            fullDesc: `ğŸ“Œ è‡³çœŸæ¥¼ã€åŸºç¡€å­¦ç§‘æ•™å­¦æ¥¼ã€‘` 
          },
          { 
            id: 3, 
            position: [102.758000, 25.059500], // è‡³å–„æ¥¼ï¼šä¸œåŒ—ä¾§
            name: "è‡³å–„æ¥¼", 
            type: "academic", 
            desc: "ä»¥æ—å­¦ã€å›­æ—ç±»ä¸“ä¸šè¯¾ç¨‹æ•™å­¦ä¸ºä¸»çš„æ•™å­¦æ¥¼", 
            fullDesc: `ğŸ“Œ è‡³å–„æ¥¼ã€æ—å­¦ä¸“ä¸šæ•™å­¦æ¥¼ã€‘` 
          },
          { 
            id: 4, 
            position: [102.759000, 25.057500], // è‡³ä¿¡æ¥¼ï¼šä¸œä¾§
            name: "è‡³ä¿¡æ¥¼", 
            type: "academic", 
            desc: "èšç„¦ç»ç®¡ã€æ–‡æ³•ç±»è¯¾ç¨‹æ•™å­¦çš„ç»¼åˆæ•™å­¦æ¥¼", 
            fullDesc: `ğŸ“Œ è‡³ä¿¡æ¥¼ã€ç»¼åˆæ–‡ç§‘æ•™å­¦æ¥¼ã€‘` 
          },
          { 
            id: 6, 
            position: [102.760000, 25.058500], // ä¸»å›¾ä¹¦é¦†ï¼šä¸œå—ä¾§
            name: "ä¸»å›¾ä¹¦é¦†", 
            type: "library", 
            desc: "é¦†è—ç™¾ä¸‡å†Œæ–‡çŒ®çš„æ ¡å†…æ ¸å¿ƒå›¾ä¹¦é¦†", 
            fullDesc: `ğŸ“Œ ä¸»å›¾ä¹¦é¦†ã€æ ¸å¿ƒé¦†è—é¦†ã€‘` 
          },
          { 
            id: 7, 
            position: [102.758500, 25.058500], // æ—ä¸šä¸“ä¸šåˆ†é¦†ï¼šä¸­ä¸œä¾§
            name: "æ—ä¸šä¸“ä¸šåˆ†é¦†", 
            type: "library", 
            desc: "ä¸“æ³¨æ—å­¦ä¸“ä¸šæ–‡çŒ®çš„ç‰¹è‰²å›¾ä¹¦é¦†", 
            fullDesc: `ğŸ“Œ æ—ä¸šä¸“ä¸šåˆ†é¦†ã€æ—å­¦ç‰¹è‰²é¦†è—é¦†ã€‘` 
          },
          { 
            id: 8, 
            position: [102.755500, 25.056500], // å—è‹‘å­¦ç”Ÿé£Ÿå ‚ï¼šè¥¿å—ä¾§
            name: "å—è‹‘å­¦ç”Ÿé£Ÿå ‚", 
            type: "dining", 
            desc: "èœå“ä¸°å¯Œã€æ€§ä»·æ¯”é«˜çš„æ ¡å†…æ ¸å¿ƒé£Ÿå ‚", 
            fullDesc: `ğŸ“Œ å—è‹‘å­¦ç”Ÿé£Ÿå ‚ã€æ ¡å›­æ ¸å¿ƒé¤é¥®ä¸­å¿ƒã€‘` 

          },
          { 
            id: 9, 
            position: [102.759500, 25.056500], // åŒ—è‹‘é£Ÿå ‚ï¼šå—ä¾§
            name: "åŒ—è‹‘é£Ÿå ‚", 
            type: "dining", 
            desc: "ä¸»æ‰“ç‰¹è‰²å°åƒçš„æ ¡å›­é£å‘³é£Ÿå ‚", 
            fullDesc: `ğŸ“Œ åŒ—è‹‘é£Ÿå ‚ã€æ ¡å›­ç‰¹è‰²é£å‘³é£Ÿå ‚ã€‘` 

          },
          { 
            id: 12, 
            position: [102.757500, 25.057000], // ä½“è‚²é¦†ï¼šä¸­å—ä¾§
            name: "ä½“è‚²é¦†", 
            type: "sports", 
            desc: "å«å¤šç§è¿åŠ¨åœºåœ°çš„ç»¼åˆä½“è‚²åœºé¦†", 
            fullDesc: `ğŸ“Œ ä½“è‚²é¦†ã€æ ¡å›­ç»¼åˆä½“è‚²ä¸­å¿ƒã€‘` 
          }
        ]
      }
    };

    // ========= æ™ºæ…§æ ¡å›­åœ°å›¾ç±» =========
    class SmartCampusMap {
      constructor() {
        this.map = null;
        this.AMap = null;
        this.markers = [];
        this.infoWindows = [];
        this.normalIcon = null;
      }

      async init() {
        try {
          // åŠ è½½é«˜å¾·åœ°å›¾
          this.AMap = await AMapLoader.load({
            key: CONFIG.amapKey,
            version: "2.0",
            plugins: ['AMap.ToolBar', 'AMap.Scale', 'AMap.HawkEye', 'AMap.MapType','AMap.InfoWindow', 'AMap.Geolocation']
          });

          // åˆ›å»º2Dåœ°å›¾å®ä¾‹
          this.map = new this.AMap.Map("container", {
            viewMode: '2D',
            zoom: CONFIG.campus.zoom,
            center: CONFIG.campus.center,
            pitch: 0,
            rotation: 0,
            mapStyle: 'amap://styles/light'
          });

          // åˆå§‹åŒ–åŠŸèƒ½
          this.initIcons();
          this.addLayers();
          this.addControls();
          this.addMarkers();
          this.updateSidebar();
          this.hideLoading();
          this.adjustView();
        } catch (error) {
          console.error('âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
          this.showError('åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥ç½‘ç»œ');
        }
      }

      // åˆå§‹åŒ–ç‚¹ä½å›¾æ ‡
      initIcons() {
        this.normalIcon = new this.AMap.Icon({ 
          size: new this.AMap.Size(40, 48), 
          image: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png", 
          imageSize: new this.AMap.Size(40, 48), 
          anchor: 'bottom-center' 
        });
      }

      // æ·»åŠ åœ°å›¾å›¾å±‚
      addLayers() {
        this.map.add([
          new this.AMap.TileLayer.Traffic({ autoRefresh: true }),
          new this.AMap.TileLayer.Satellite(),
          new this.AMap.TileLayer.RoadNet()
        ]);
      }

      // æ·»åŠ åœ°å›¾æ§ä»¶
      addControls() {
        this.map.addControl(new this.AMap.ToolBar({ position: 'RT' }));
        this.map.addControl(new this.AMap.Scale({ position: 'LB' }));
        this.map.addControl(new this.AMap.HawkEye({ isOpen: true, position: 'RB' }));
        this.map.addControl(new this.AMap.MapType({ defaultType: 0, position: 'RT' }));
        this.map.addControl(new this.AMap.Geolocation({ position: 'LB', showCircle: false }));
      }

      // æ¸²æŸ“ç‚¹ä½æ ‡è®°ï¼ˆå·²åˆ é™¤å®éªŒæ¥¼ï¼Œåæ ‡é‡æ–°è°ƒæ•´ï¼‰
      addMarkers() {
        const { spots } = CONFIG.campus;
        const _this = this;
        
        // æ·»åŠ æ ¡å›­ä¸­å¿ƒç‚¹æ ‡è®°
        const mainMarker = new this.AMap.Marker({ 
          position: CONFIG.campus.center, 
          icon: this.normalIcon, 
          anchor: 'bottom-center', 
          zIndex: 100 
        });
        const mainInfoWindow = new this.AMap.InfoWindow({ 
          content: this.getCampusInfoContent(), 
          offset: new this.AMap.Pixel(0, -100), 
          closeWhenClickMap: true 
        });
        mainMarker.on('click', function() { 
          _this.closeAllInfoWindows(); 
          mainInfoWindow.open(_this.map, CONFIG.campus.center); 
          _this.infoWindows.push(mainInfoWindow); 
        });
        this.map.add(mainMarker);
        this.markers.push(mainMarker);

        // å¾ªç¯æ·»åŠ æ‰€æœ‰ä¿ç•™çš„ç‚¹ä½æ ‡è®°
        spots.forEach(spot => {
          const marker = new this.AMap.Marker({ 
            position: spot.position, 
            icon: this.normalIcon, 
            anchor: 'bottom-center', 
            title: spot.name, 
            extData: spot,
            zIndex: 90 
          });
          const infoWindow = new this.AMap.InfoWindow({ 
            content: this.getSpotInfoContent(spot), 
            offset: new this.AMap.Pixel(0, -60), 
            closeWhenClickMap: true 
          });
          
          marker.on('click', function() {
            _this.closeAllInfoWindows();
            infoWindow.open(_this.map, spot.position);
            _this.infoWindows.push(infoWindow); 
            _this.map.setCenter(spot.position);
            _this.map.setZoom(18);
          });
          this.map.add(marker);
          this.markers.push(marker);
        });
      }

      // æ ¡å›­ä¸­å¿ƒç‚¹å¼¹çª—å†…å®¹
      getCampusInfoContent() {
        return `<div style="width: 320px; padding: 15px;">
          <h3 style="color: #009688; margin: 0 0 10px 0; font-size: 16px;">${CONFIG.campus.name}</h3>
          <p style="margin: 0; color: #666; line-height: 1.7; font-size: 14px; white-space: pre-line;">
            ${CONFIG.campus.intro}<br/><br/>
            ğŸ“ è¯¦ç»†åœ°å€ï¼šäº‘å—çœæ˜†æ˜å¸‚ç›˜é¾™åŒºç™½é¾™å¯º300å·<br/>
            ğŸš å‡ºè¡Œä¾¿åˆ©ï¼šå‘¨è¾¹å¸ƒè®¾æœ‰å¤šä¸ªå…¬äº¤ç«™ç‚¹ï¼Œæ–¹ä¾¿å¸ˆç”Ÿå‡ºè¡Œ<br/>
            ğŸŒ¿ åŠå­¦ç‰¹è‰²ï¼šæ—å­¦ã€é£æ™¯å›­æ—ä¸ºå›½å®¶çº§ç‰¹è‰²ä¸“ä¸šï¼Œæ‹¥æœ‰å¤šä¸ªçœçº§æ—ä¸šç§‘ç ”å¹³å°ã€‚
          </p>
        </div>`;
      }

      // ç‚¹ä½å¼¹çª—å†…å®¹
      getSpotInfoContent(spot) {
        return `<div style="width: 340px; padding: 15px; border-radius: 8px;">
          <h4 style="color: #009688; margin: 0 0 10px 0; font-size: 16px; font-weight: bold;">${spot.name}</h4>
          <p style="margin: 0; color: #333; line-height: 1.7; font-size: 14px; white-space: pre-line;">${spot.fullDesc}</p>
          <div style="margin-top:12px;font-size:12px;color:#888;text-align:right;">ç‚¹å‡»åœ°å›¾ç©ºç™½å¤„å…³é—­çª—å£</div>
        </div>`;
      }

      // å…³é—­æ‰€æœ‰å¼¹çª—
      closeAllInfoWindows() {
        this.infoWindows.forEach(window => window.close());
        this.infoWindows = [];
      }

      // æ¸²æŸ“ä¾§è¾¹æ ï¼ˆæ— å®éªŒæ¥¼ï¼‰
      updateSidebar() {
        document.getElementById('campus-intro').textContent = CONFIG.campus.intro.replace(/\n/g, ' ');
        document.getElementById('spot-list').innerHTML = CONFIG.campus.spots.map(spot => 
          `<div class="spot-item" onclick="campusMap.flyToSpot(${spot.id})">
            <strong>${spot.name}</strong>
            <p>${spot.desc.substring(0, 40)}...</p>
          </div>`
        ).join('');
      }

      // ä¾§è¾¹æ ç‚¹å‡»è·³è½¬ç‚¹ä½
      flyToSpot(spotId) {
        const spot = CONFIG.campus.spots.find(s => s.id === spotId);
        if(spot){
          this.map.setCenter(spot.position);
          this.map.setZoom(18);
          const marker = this.markers.find(m => m.getExtData()?.id === spotId);
          marker && marker.emit('click');
        }
      }

      // è‡ªé€‚åº”è§†é‡
      adjustView() {
        if(this.markers.length>0)
          this.map.setFitView(this.markers, false, [80,80,80,80]);
      }

      // éšè—åŠ è½½åŠ¨ç”»
      hideLoading() {
        document.getElementById('loading').style.display = 'none';
      }

      // åŠ è½½å¤±è´¥æç¤º
      showError(message) {
        document.getElementById('loading').innerHTML = `<div style="text-align:center;color:#f44336;">
          <div style="font-size:48px;margin-bottom:20px;">âš ï¸</div>
          <h3>åŠ è½½å¤±è´¥</h3>
          <p>${message}</p>
          <button onclick="location.reload()" style="margin-top:20px;padding:10px 20px;background:#009688;color:white;border:none;border-radius:5px;cursor:pointer;">é‡æ–°åŠ è½½</button>
        </div>`;
      }
    }

    // åˆå§‹åŒ–åœ°å›¾
    let campusMap;
    document.addEventListener('DOMContentLoaded', () => {
      campusMap = new SmartCampusMap();
      campusMap.init();
      window.campusMap = campusMap;
    });

    // çª—å£ç¼©æ”¾é€‚é…
    window.addEventListener('resize', () => {
      if(campusMap && campusMap.map)
        campusMap.map.setFitView(campusMap.markers, false, [80,80,80,80]);
    });
  </script>
</body>
</html>
